<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">

  <!-- Product Definition -->
  <Product Id="*"
           Name="TidyPackRat File Organizer"
           Language="1033"
           Version="1.0.0.0"
           Manufacturer="TidyPackRat"
           UpgradeCode="A1B2C3D4-E5F6-4A5B-8C9D-1E2F3A4B5C6D">

    <Package InstallerVersion="200"
             Compressed="yes"
             InstallScope="perMachine"
             Description="TidyPackRat File Organizer - Sorting your files, to clean up your mess."
             Comments="Automated file management system for Windows" />

    <!-- Upgrade rules -->
    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />

    <!-- Media definition -->
    <MediaTemplate EmbedCab="yes" />

    <!-- Require Windows 10 or later -->
    <Condition Message="This application requires Windows 10 or later.">
      <![CDATA[Installed OR (VersionNT >= 603)]]>
    </Condition>

    <!-- Check for PowerShell 5.1 or later -->
    <Property Id="POWERSHELLVERSION">
      <RegistrySearch Id="PowerShellVersionSearch"
                      Root="HKLM"
                      Key="SOFTWARE\Microsoft\PowerShell\3\PowerShellEngine"
                      Name="PowerShellVersion"
                      Type="raw" />
    </Property>

    <Condition Message="This application requires PowerShell 5.1 or later. Please install Windows Management Framework 5.1 or later.">
      <![CDATA[Installed OR POWERSHELLVERSION >= "5.1"]]>
    </Condition>

    <!-- Feature definition -->
    <Feature Id="ProductFeature"
             Title="TidyPackRat File Organizer"
             Level="1"
             Description="Complete installation of TidyPackRat File Organizer">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentGroupRef Id="WorkerScriptComponents" />
      <ComponentGroupRef Id="ConfigComponents" />
      <ComponentRef Id="LogsFolder" />
      <ComponentRef Id="ProgramMenuShortcut" />
      <ComponentRef Id="DesktopShortcut" />
    </Feature>

    <!-- UI Configuration -->
    <UIRef Id="WixUI_InstallDir" />
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />

    <!-- Custom UI with branding -->
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />
    <!-- <WixVariable Id="WixUIBannerBmp" Value="Banner.bmp" /> -->
    <!-- <WixVariable Id="WixUIDialogBmp" Value="Dialog.bmp" /> -->
  </Product>

  <!-- Fragment: Directory structure -->
  <Fragment>
    <Directory Id="TARGETDIR" Name="SourceDir">
      <!-- Program Files -->
      <Directory Id="ProgramFilesFolder">
        <Directory Id="INSTALLFOLDER" Name="TidyPackRat">
          <Directory Id="GUIFOLDER" Name="GUI" />
          <Directory Id="WORKERFOLDER" Name="Worker" />
        </Directory>
      </Directory>

      <!-- ProgramData for configuration and logs -->
      <Directory Id="CommonAppDataFolder">
        <Directory Id="APPDATAFOLDER" Name="TidyPackRat">
          <Directory Id="LOGSFOLDER" Name="logs" />
        </Directory>
      </Directory>

      <!-- Start Menu -->
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="TidyPackRat" />
      </Directory>

      <!-- Desktop -->
      <Directory Id="DesktopFolder" Name="Desktop" />
    </Directory>
  </Fragment>

  <!-- Fragment: Main application components -->
  <Fragment>
    <ComponentGroup Id="ProductComponents" Directory="GUIFOLDER">
      <!-- Main GUI executable -->
      <Component Id="TidyPackRatExe" Guid="B1C2D3E4-F5A6-4B7C-8D9E-1F2A3B4C5D6E">
        <File Id="TidyPackRatExeFile"
              Source="$(var.SourceDir)\gui\TidyPackRat.exe"
              KeyPath="yes" />
      </Component>

      <!-- GUI dependencies -->
      <Component Id="NewtonsoftJson" Guid="C2D3E4F5-A6B7-4C8D-9E1F-2A3B4C5D6E7F">
        <File Id="NewtonsoftJsonDll"
              Source="$(var.SourceDir)\gui\Newtonsoft.Json.dll"
              KeyPath="yes" />
      </Component>

      <!-- Config file -->
      <Component Id="AppConfig" Guid="D3E4F5A6-B7C8-4D9E-1F2A-3B4C5D6E7F8A">
        <File Id="AppConfigFile"
              Source="$(var.SourceDir)\gui\TidyPackRat.exe.config"
              KeyPath="yes" />
      </Component>
    </ComponentGroup>
  </Fragment>

  <!-- Fragment: Worker script components -->
  <Fragment>
    <ComponentGroup Id="WorkerScriptComponents" Directory="WORKERFOLDER">
      <Component Id="WorkerScript" Guid="E4F5A6B7-C8D9-4E1F-2A3B-4C5D6E7F8A9B">
        <File Id="WorkerScriptFile"
              Source="$(var.SourceDir)\worker\TidyPackRat-Worker.ps1"
              KeyPath="yes" />
      </Component>
    </ComponentGroup>
  </Fragment>

  <!-- Fragment: Configuration components -->
  <Fragment>
    <ComponentGroup Id="ConfigComponents" Directory="APPDATAFOLDER">
      <Component Id="DefaultConfig" Guid="F5A6B7C8-D9E1-4F2A-3B4C-5D6E7F8A9B0C">
        <File Id="DefaultConfigFile"
              Source="$(var.SourceDir)\config\default-config.json"
              Name="config.json"
              KeyPath="yes" />
      </Component>

    </ComponentGroup>
  </Fragment>

  <!-- Fragment: Logs directory component -->
  <Fragment>
    <DirectoryRef Id="LOGSFOLDER">
      <Component Id="LogsFolder" Guid="A6B7C8D9-E1F2-4A3B-4C5D-6E7F8A9B0C1D">
        <CreateFolder />
        <RemoveFolder Id="RemoveLogsFolder" On="uninstall" />
        <RegistryValue Root="HKCU"
                      Key="Software\TidyPackRat"
                      Name="LogsFolder"
                      Type="string"
                      Value="[LOGSFOLDER]"
                      KeyPath="yes" />
      </Component>
    </DirectoryRef>
  </Fragment>

  <!-- Fragment: Start Menu shortcuts -->
  <Fragment>
    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="ProgramMenuShortcut" Guid="B7C8D9E1-F2A3-4B4C-5D6E-7F8A9B0C1D2E">
        <!-- Configuration shortcut -->
        <Shortcut Id="ConfigShortcut"
                  Name="TidyPackRat Configuration"
                  Description="Configure TidyPackRat file organization"
                  Target="[GUIFOLDER]TidyPackRat.exe"
                  WorkingDirectory="GUIFOLDER" />

        <!-- Uninstall shortcut -->
        <Shortcut Id="UninstallShortcut"
                  Name="Uninstall TidyPackRat"
                  Description="Uninstall TidyPackRat File Organizer"
                  Target="[System64Folder]msiexec.exe"
                  Arguments="/x [ProductCode]" />

        <RemoveFolder Id="ApplicationProgramsFolder" On="uninstall" />

        <RegistryValue Root="HKCU"
                      Key="Software\TidyPackRat"
                      Name="StartMenuShortcut"
                      Type="integer"
                      Value="1"
                      KeyPath="yes" />
      </Component>
    </DirectoryRef>
  </Fragment>

  <!-- Fragment: Desktop shortcut (optional) -->
  <Fragment>
    <DirectoryRef Id="DesktopFolder">
      <Component Id="DesktopShortcut" Guid="C8D9E1F2-A3B4-4C5D-6E7F-8A9B0C1D2E3F">
        <Shortcut Id="DesktopConfigShortcut"
                  Name="TidyPackRat"
                  Description="Configure TidyPackRat file organization"
                  Target="[GUIFOLDER]TidyPackRat.exe"
                  WorkingDirectory="GUIFOLDER" />

        <RegistryValue Root="HKCU"
                      Key="Software\TidyPackRat"
                      Name="DesktopShortcut"
                      Type="integer"
                      Value="1"
                      KeyPath="yes" />
      </Component>
    </DirectoryRef>
  </Fragment>

</Wix>
